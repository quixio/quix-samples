FROM ghcr.io/marimo-team/marimo:latest

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=UTF-8 \
    MARIMO_USER_CONFIG_PATH=/app/state \
    MARIMO_MODE="browser" \
    MARIMO_NOTEBOOK="main.py" \
    QUIX_PLUGIN_MODE="false"

# Set working directory
WORKDIR /app

# Install nginx and supervisor
USER root
RUN apt-get update && apt-get install -y nginx supervisor && rm -rf /var/lib/apt/lists/*

# Create state directory
RUN mkdir -p /app/state

# Copy requirements first to leverage Docker layer caching
COPY requirements.txt .

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Install quixportal for token validation (with fsspec dependency)
RUN pip install --no-cache-dir fsspec>=2024.6.0 && \
    pip install --no-cache-dir \
    -i https://pkgs.dev.azure.com/quix-analytics/53f7fe95-59fe-4307-b479-2473b96de6d1/_packaging/public/pypi/simple/ \
    quixportal

# Copy the application files (main.py won't overwrite if exists)
COPY main.py /tmp/main.py
RUN cp -n /tmp/main.py ./main.py || true
COPY auth_proxy.py .
COPY nginx.conf /etc/nginx/nginx.conf

# Install quixlake SDK directly from GitHub URL
RUN pip install --no-cache-dir \
    "https://github.com/quixio/quix-samples/raw/task/marimo-template/python/others/marimo/quixlake_sdk-0.2.1-py3-none-any.whl"

# Expose port
EXPOSE 8080

# Create default marimo config with dark theme
RUN mkdir -p /app/state && \
    printf '[display]\ntheme = "dark"\ncode_editor_font_size = 14\n\n[completion]\nactivate_on_typing = true\ncopilot = false\n\n[formatting]\nline_length = 79\n\n[runtime]\nauto_instantiate = true\n\n[save]\nautosave = "after_delay"\nautosave_delay = 1000\nformat_on_save = false\n\n[keymap]\npreset = "default"\n' > /app/state/marimo.toml

# Create supervisor config
RUN printf '[supervisord]\n\
nodaemon=true\n\
logfile=/dev/stdout\n\
logfile_maxbytes=0\n\
\n\
[program:nginx]\n\
command=nginx -g "daemon off;"\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
\n\
[program:auth_proxy]\n\
command=python /app/auth_proxy.py\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
\n\
[program:marimo]\n\
command=/app/start_marimo.sh\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
' > /etc/supervisor/conf.d/supervisord.conf

# Create marimo startup script (handles browser mode)
RUN printf '#!/bin/bash\n\
if [ "$MARIMO_MODE" = "browser" ]; then\n\
    exec marimo edit --host 127.0.0.1 -p 8081 --no-token\n\
else\n\
    exec marimo "$MARIMO_MODE" "$MARIMO_NOTEBOOK" --host 127.0.0.1 -p 8081 --no-token\n\
fi\n\
' > /app/start_marimo.sh && chmod +x /app/start_marimo.sh

# Create startup script that checks QUIX_PLUGIN_MODE
RUN printf '#!/bin/bash\n\
if [ "$QUIX_PLUGIN_MODE" = "true" ]; then\n\
    # Plugin mode: use nginx + auth proxy\n\
    exec supervisord -c /etc/supervisor/conf.d/supervisord.conf\n\
else\n\
    # Standalone mode: direct marimo access (with optional password)\n\
    if [ "$MARIMO_MODE" = "browser" ]; then\n\
        if [ -n "$MARIMO_PASSWORD" ]; then\n\
            exec marimo edit --host 0.0.0.0 -p 8080 --token-password "$MARIMO_PASSWORD"\n\
        else\n\
            exec marimo edit --host 0.0.0.0 -p 8080\n\
        fi\n\
    else\n\
        if [ -n "$MARIMO_PASSWORD" ]; then\n\
            exec marimo "$MARIMO_MODE" "$MARIMO_NOTEBOOK" --host 0.0.0.0 -p 8080 --token-password "$MARIMO_PASSWORD"\n\
        else\n\
            exec marimo "$MARIMO_MODE" "$MARIMO_NOTEBOOK" --host 0.0.0.0 -p 8080\n\
        fi\n\
    fi\n\
fi\n\
' > /app/start.sh && chmod +x /app/start.sh

CMD ["/app/start.sh"]
